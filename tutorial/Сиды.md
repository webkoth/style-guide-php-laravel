#develop/tree 

Итак, вы создали и запустили миграции, а также создали все необходимые модели. Кажется, что база данных готова к работе, но на самом деле не совсем. Дело в том, что очень сложно тестировать и даже просто разрабатывать приложение с пустой БД: так не получится проверить как выглядят страницы или какой ответ возвращает API в зависимости от содержимого БД. Чтобы вам не приходилось заниматься заполнением БД тестовой информацией вручную, в фреймворке есть концепция «сидирования» (от англ. засевать).
Для каждой модели можно создать её класс-“сид», который поможет заполнить таблицу любым количеством записей.

Ну что, отправимся на посевную?

## Фабрики моделей

Однако, прежде чем мы рассмотрим тему сидов, нам понадобится познакомиться с другой возможностью Laravel — фабрике моделей.
Фабрика моделей, как можно догадаться из названия, предназначена для массового производства моделей.
Это означает, что специальный класс-фабрика способен заполнить таблицу моделей множеством разных записей.

Модель и её фабрика — это два разных класса, но они могут «дружить» благодаря соглашению по именованию: имя класса фабрики должно быть таким: ИмяМоделиFactory Например, для модели с именем Show фабрика будет называться Show

Сгенерировать заготовку фабрики можно с помощью artisan:

```shell
php artisan make:factory ShowFactory
```

Теперь посмотрим на заполненную фабрику на примере этой же модели Show:

ShowFactory.php
```php
<?php

namespace Database\Factories;

use App\Models\Show;
use Illuminate\Database\Eloquent\Factories\Factory;

class ShowFactory extends Factory
{
    /**
     * The name of the factory's corresponding model.
     *
     * @var string
     */
    protected $model = Show::class;

    /**
     * Define the model's default state.
     *
     * @return array
     */
    public function definition()
    {
        return [
            'title' => $this->faker->words(3, true),
            'title_original' => $this->faker->words(3, true),
            'description' => $this->faker->sentences(3, true),
            'year' => (int) $this->faker->year,
            'status' => $this->faker->randomElement(['new', 'ended']),
        ];
    }
}
```

Как видите, здесь используется уже знакомая вам библиотека faker для генерации случайных данных по определённому формату. Всё описание класса фабрики сводится к заполнению метода definition: он должен возвращать массив с ключами-свойствами модели и значениями, полученными от faker.
Выходит, что фабрика сама по себе не создаёт записи и не отвечает за их количество. Здесь лишь содержится так называемая разметка для полей.

## Сиды
Теперь разберёмся с сидами.
Создать сид для модели можно также через artisan:

```php
php artisan make:seeder ShowSeeder
```

В созданном классе будет только один метод run (), который и следует заполнить кодом, организующим запуск и выполнение фабрики модели.

Посмотрим на пример сида для заполнения таблицы с сериалами:

```php
<?php

namespace Database\Seeders;

class ShowsSeeder extends Seeder
{
    public function run()
    {
        Show::factory()->count(5)->create();
    }
}
```

Всё предельно просто: метод factory() возвращает фабрику для модели. Затем мы требуем создать пять записей и сохраняем их в БД. Возможно, внимательный читатель здесь может спросить: а как же связи? Действительно, мы не объявляли заполнения связанных таблиц в классе-фабрике, как и в самом сидере. Откуда же им взяться? Всё верно: связи нужно определить явно.

## Связи в сидах

Для начала вспомним какие связи есть у модели сериала:

- серии (эпизоды)
- жанры

Будет логично создать всю эту цепочку за один раз: добавим сериалы, к каждому сериалу привяжем несколько эпизодов, а также пару жанров. Кстати, к эпизодам сразу можно добавить и комментарии, чтобы два раза не вставать, как говорится.

Сидеры и фабрики позволяют создавать связанные модели «на лету»: т. е. можно описать в одном месте всё необходимое, не создавая для каждой связи отдельный сидер. Главное, чтобы в самих моделях связи уже были определены.
Начнём с эпизодов для сериала.

Посколько эпизод — это отдельная сущность со своими атрибутами, нам потребуется создать для него свою собственную фабрику.

EpisodeFactory.php
```php
<?php

namespace Database\Factories;

use App\Models\Episode;
use Illuminate\Database\Eloquent\Factories\Factory;

class EpisodeFactory extends Factory
{
    /**
     * The name of the factory's corresponding model.
     *
     * @var string
     */
    protected $model = Episode::class;

    /**
     * Define the model's default state.
     *
     * @return array
     */
    public function definition()
    {
        return [
            'title' => $this->faker->words(3, true),
            'show_id' => 0,
            'season' => random_int(1, 5),
            'episode_number' => random_int(1, 20),
            'air_at' => $this->faker->dateTime(),
        ];
    }
}
```

Теперь вернёмся к ShowsSeeder и добавим туда указание создать связанные модели-эпизоды:
```php
public function run()
{
    Show::factory()
        ->count(5)
        ->has(Episode::factory()->count(10)->hasComments(3))
        ->create();
}
```

Здесь добавился метод has (), который подходит для заполнения связей многие-к-одному от имени родительской модели. Этот метод принимает объект фабрики. Имя связи автоматически распознаётся на основе имени переданного класса. Т.е. на основе класса Episode, Laravel попытается найти связь с именем episodes и заполнить её моделями.

На самом деле, метод has () подходит еще и для связей «многие-ко-многим», что мы увидим на примере жанров. Отношение сериал-жанр как раз является примером этой связи, потому что у множества сериалов может быть множество жанров.

```php
public function run()
{
    Show::factory()
    ->count(5)
    ->has(Episode::factory()->count(10)->hasComments(3))
    ->has(Genre::factory()->count(3))
    ->create();
}

```

## Запуск сидов

Для запуска сидов используется, как обычно, специальная artisan команда. У вас есть выбор запустить все сиды или только один конкретный:

```shell
php artisan db:seed --class=ShowsSeeder
```

Если опустить здесь параметр class, то будут выполнены все сиды. В противном случае выполнится только сид для сериалов.

prev:[[Migration]] next:[[Laravel Sanctum]]
