#develop/tree 

Теперь, когда вы знаете как работают очереди и какое значение в этом играют задачи (Jobs), у вас, возможно, возникнет вопрос: а в чем приниципиальная разница между командой и задачей, ведь и то и другое является произвольным классом, в котором описывается работа, выполняемая в фоне (т.е. не в процессе обработки запроса пользователя, а асинхронно). В каких ситуациях лучше использовать задачи, а в каких команды? Давайте разбираться!

## Простое обьяснение

Обычно мы используем команду для выполнения определенной функции или задания в определенное время или с определенной частотой. Команду также можно вызвать через терминал. Но задача не может быть вызвана через терминал. Задачи же можно ставить в очередь. Кроме того, вы можете выполнить задачу в определенное время, используя [планировщик](https://laravel.com/docs/10.x/scheduling) Laravel, но это не повторяющееся событие.

## Чем являются команды

Давайте теперь более подробно разберемся в отличиях этих двух схожих концепций.

Команды в Laravel работают как отдельные крон-задачи. В действительности, в Laravel есть одна мастер-команда (это и есть тот самый планировщик), который отвечает за запуск ваших кастомных команд. Вы можете использовать планироващик чтобы назначить регулярность запуска этой команды. Например, вот так:

```php
// app/Console/Kernel.php

namespace App\Console;

use Illuminate\Console\Scheduling\Schedule;
use Illuminate\Foundation\Console\Kernel as ConsoleKernel;

class Kernel extends ConsoleKernel
{
  protected function schedule(Schedule $schedule): void
  {
    $schedule
      ->command('contact-email:send')
      ->everyTenMinutes();
  }
}
```

Возьмем для примера команду для отправки email-уведомлений.

Иногда вы можете оказаться в ситуации, когда отправка писем занимает много времени (например, когда нужно отправить массу писем). На данный момент наша команда должна выполняться в течение 10 минут, иначе начнется выполнение другого задания cron.

Это нежелательное поведение, потому что, если первое задание cron не завершило отправку электронного письма, второе задание cron может взять тот же контактный адрес электронной почты и начать его отправку, что приведет к дублированию писем с подтверждением.

Чтобы предотвратить такое поведение, можно увеличеть частоту расписания, либо указать, что любое ожидающее задание cron должно быть завершено до того, как сможет начаться другое.

## Чем являются задачи

Когда команды не привязаны к какому-либо конкретному времени для отправки (что означает «выполнить эти задачи как можно скорее»), можно рассматривать задачи как список заданий, которые необходимо выполнить. Сервер возьмет их по одному, когда у него будет время и ресурсы.

Это означает, что вы не можете заранее определить, когда задача будет выполнена.

Однако, поскольку они задачи выполняются одна за одной, вам не нужно заботиться об их возможном перекрытии.

Другим преимуществом является то, что вы можете масштабировать задачи, потому что вы можете контролировать, сколько исполнителей запускают ваши задачи. Это означает, что если у сайта есть период времени, когда на нем бывает больше обычного трафика, то вы можете решить добавить больше исполнителей, чтобы быстрее разгребсти эту очередь из заданий и помочь пользователям получать их подтверждение по электронной почте быстрее.

Посмотрим на пример как запустить задание:

```php
// app/Http/Controllers/ContactController.php

namespace App\Http\Controllers;

use App\Jobs\SendContactEmail;
use App\Jobs\SendContactConfirmation;
use App\Http\Requests\StoreContactRequest;

class ContactController extends Controller
{
  public function store(StoreContactRequest $request)
  {
    $email = $request->email;
    $subject = $request->subject;
    $content = $request->content;

    // For the company
    dispatch(new SendContactEmail($email, $subject, $content));

    // For the web user
    dispatch(new SendContactConfirmation($email, $subject, $content));

    return redirect()->route("contact.success");
  }
}
```

Удобство заключается еще и в том, что если отправка сообщения по какой-то причине упадёт с ошибкой, то вам не надо обрабатывать это условие особым образом, ведь задачи из очереди автоматически умеют запускаться повторно.

Еще одно преимущество заключается в том, что статус задач удобно отслеживать с помощью веб-интерфейса Laravel Telescope. Здесь можно следить сколько задач ожидает в очереди, сколько выполнено и какой их статус.

prev:[[Тестирование очереди]]

