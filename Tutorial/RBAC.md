#develop/tree 

**RBAC** — это управление доступом на основе ролей. Данный подход означает, что вы можете очень гибко настраивать доступ к отдельным ресурсам приложения для отдельных пользовeателей, назначая им роли и прописывая дополнительные условия.

В Laravel rbac не поддерживается из коробки, но зато его можно частично заменить иными Laravel-специфичными подходами.

## Немного теории

Поскольку веб-приложения становятся все более сложными, важно обеспечить доступ пользователей только к тем возможностям и данным, которые им необходимы.

Авторизация на основе ролей — это популярный подход к управлению контролем доступа, при котором пользователям назначаются роли и разрешения в зависимости от их должности или обязанностей в системе.

## Концепция гейтов (gates) в Laravel

В PHP-фреймворке Laravel ролевая авторизация реализована с помощью возможности под названием Gates. Гейты — это способ определения логики авторизации в централизованном месте, что упрощает управление контролем доступа во всем приложении.

## Итак, для чего же предназначены Laravel Gates?

Гейты — это, по сути, набор правил, которые определяют, имеет ли пользователь право на выполнение определенного действия или доступ к определенному ресурсу. Эти правила могут быть определены в специальном файле или в самом контроллере, и они могут быть применены к любому аспекту приложения, требующему контроля доступа.

## Роли и пользователи

Мы уже решили, что роль значит по сути просто заранее известные определенный набор действий, доступных пользователю.
Так, пользователю может быть назначена роль «Модератор», что позволит ему не только пользоваться сайтом как обычный юзер, но и также иметь возможность редактировать или удалять отдельный контент других пользователей.

## Как хранить и назначать роли

Чтобы хранить и назначать роли для пользователей в веб-приложении, вам проще всего использовать таблицу базы данных с пользователям для хранения информации о назначенных им ролях.
Затем вы можете использовать встроенную в Laravel систему аутентификации для управления входом пользователей в систему. После того как пользователь прошел аутентификацию, вы можете получить назначенные ему роли из базы данных и использовать их для определения возможностей, к которым он имеет доступ.

Вот пример того, как добавить роль для пользователя в Laravel:

```php
$user = User::find($id);
$user->roles()->attach($roleId);
```

Конечно, перед этим вы должны определить таблицу roles и добавить связь с пользователями.

В этом примере мы получаем пользователя по его ID, а затем используем метод attach() для назначения ему новой роли на основе его ID.

## Создание гейтов

Итак, прежде чем использовать гейт для проверки доступа к ресурсу, его надо определить и зарегистрировать. Сделать это можно в одном месте.
Давайте напишем гейт, который будет проверять роль пользователя чтобы разрешить или запретить определенное действие.

```php
Gate::define('comment-delete', function (User $user, Comment $comment) {
    if ($user->isModerator()) {
        return true;
    }

    return $user->id === $comment->user_id && $comment->comments->isEmpty();
});
```

В этом примере мы проверяем роль пользователя: если это модератор, то ему позволено удалять любые комментарии.
Если у юзера нет роли, то ему будет позволено удалять только свои комментарии.

## Регистрация гейтов

Обычно гейты определяются в методе boot класса App\Providers\AuthServiceProvider с использованием фасада Gate. Гейт всегда получает пользовательский экземпляр в качестве своего первого аргумента и может получать дополнительные аргументы, такие как соответствующая модель Eloquent.

## Использование гейтов

После того как вы назначили роли пользователям, вы можете использовать Laravel Gates для проверки того, есть ли у пользователя разрешение на выполнение определенного действия. Вот пример использования гейтов внутри контроллера:

```php
public function editPost(Post $post)
{
    if (Gate::allows('comment-delete', $post)) {
        // Юзер авторизован для выполнения этого действия
        return $this->success(null, 201);
    } else {
        // Юзер не имеет доступа к удалению комментария
        abort(403);
    }
}
```

В этом примере мы используем метод allows () фасада Gate, чтобы проверить, есть ли у пользователя разрешение на редактирование конкретного сообщения. Если есть, мы возвращаем успешный ответ для редактирования сообщения. Если нет, мы прерываем запрос с ошибкой 403.

Ограничение на основе ролей
Для некоторых ситуаций использование гейтов возможно избыточно и достаточно будет просто проверить роль пользователя перед допуском к выполнению действия. В таком случае можно использовать проверку роли перед запуском действия посредством возможностей привязки middleware к контроллеру.

Определим логику новой Middleware:

```php
<?php

namespace App\Http\Middleware;

use App\Models\User;
use Closure;
use Illuminate\Auth\Access\AuthorizationException;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;

class EnsureUserHasRole
{
    public function handle(Request $request, Closure $next, string $role)
    {
        if (!method_exists(User::class, $role) ) {
            throw new \LogicException("Метод $role отсутствует у модели пользователя");
        }

        if (!Auth::check() || !Auth::user()->$role()) {
            throw new AuthorizationException();
        }

        return $next($request);
    }
}
```

Теперь осталось привязать её к отдельным действиям. Например, добавим такое ограничение для проверки доступа к редактированию фильма. Для этого укажем название middleware и дополнительный параметр в определении роута:

```php
Route::patch('/films/{film}', 'update')->middleware(['auth:sanctum', 'role:isModerator'])->name('films.update');
```

## Заключение

В целом, концепция гейтов предоставляет мощный и гибкий способ управления авторизацией на основе ролей в вашем веб-приложении. Определяя логику авторизации в централизованном месте, вы можете гарантировать, что контроль доступа будет единообразным во всем вашем приложении.

prev:[[2_resources/develop/laravel/tutorial/Validation]] next:[[Что такое автоматизированное тестирование ?]]
