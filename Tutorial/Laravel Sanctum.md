#develop/tree 

Laravel Sanctum — это компонент Laravel (который, однако, надо установить отдельно), который предоставляет простой способ для аутентификации пользователей на основе токенов, что необходимо для разработки API-сервера, который обслуживает нужды SPA или мобильных приложений.
Отличие токена от пароля в том, что токены предоставляют более безопасную альтернативу, т. к. их можно отозвать, а также ограничить доступные действия списком разрешенных.
Клиентское приложение должно передавать такой токен при каждом запросе вместе с заголовком Authorization.

## Установка
Т.к. Sanctum не входит в стандартную поставку Laravel, его надо установить отдельно как обычный composer-пакет:

```shell
composer require laravel/sanctum
```

Следующим шагом надо опубликовать конфигурации и миграции Sanctum из его папки vendor в папку вашего проекта:

```shell
php artisan vendor:publish --provider="Laravel\Sanctum\SanctumServiceProvider"
```

И в заключение вы должны запустить миграцию, которая создаст таблицу для хранения токенов пользователя:

```shell
php artisan migrate
```

## Добавление поддержки токенов

Как было сказано выше, главная обязанность Sanctum — это выпуск и обслуживание токенов. У одного пользователя может быть много токенов и хранятся они в отдельной таблице, которую вы создали ранее в рамках запуска миграции.

Центральная сущность всех процессов авторизации и аутентификации — это модель пользователя User, поэтому нам также понадобится немного её поменять, чтобы получить возможность выпускать и проверять токены напрямую из этой модели.

Чтобы начать выдачу токенов для пользователей, ваша модель User должна использовать трейт Laravel\Sanctum\HasApiTokens:

```php
use Laravel\Sanctum\HasApiTokens;
 
class User extends Authenticatable
{
    use HasApiTokens, HasFactory, Notifiable;
}
```

Теперь, чтобы выпустить токен, вы можете использовать метод createToken. Вы увидите как это работает в следующей главе, где мы будем делать регистрацию и аутентификацию пользователя.

## Ограничение доступа

Помимо возможностей по выпуску токенов, пакет Sanctum помогает также организовать проверку доступа к роутам. Такая проверка задаётся в routes/api.php:

```php
Route::prefix('user')->name('user.')->middleware('auth:sanctum')->group(function () {
    Route::patch('/', [UserController::class, 'update'])->name('update');
    Route::get('/shows', [UserController::class, 'shows'])->name('shows.index');
    Route::get('/shows/{show}/new-episodes', [UserController::class, 'newEpisodes'])->name('shows.new-episodes');
    Route::post('/shows/watch/{show}', [UserController::class, 'watchShow'])->name('shows.watch');
    Route::delete('/shows/watch/{show}', [UserController::class, 'unwatchShow'])->name('shows.unwatch');
    Route::post('/episodes/watch/{episode}', [UserController::class, 'watchEpisode'])->name('episodes.watch');
    Route::delete('/episodes/watch/{episode}', [UserController::class, 'unwatchEpisode'])->name('episodes.unwatch');
    Route::post('/shows/{show}/vote', [UserController::class, 'vote'])->name('shows.vote');
});
```


Обратите внимание, что здесь роуты объединены в одну группу и для всей этой группы добавлен специальный middleware auth:sanctum.

Работает он очень просто: при обработки запроса с этого роута, данный middleware проверяет, что у клиента в запросе присутствует заголовок Authorization и проверяет его значение: ищет пользователя с таким токеном. Если пользователь не найден, то вместо доступа к оригинальному ресурсу, клиенту вернётся код ошибки 403.

## Аутентификация в SPA

Также Sanctum предлагает простой способ аутентификации одностраничных приложений (SPA), которым необходимо взаимодействовать с API на базе Laravel. Эти SPA могут существовать в том же репозитории, что и ваше приложение Laravel, или могут быть полностью отдельным репозиторием, например, SPA, созданным с помощью Vue CLI или приложения Next.js.

Для этой функции Sanctum не использует токены. Вместо этого Sanctum использует встроенные в Laravel службы аутентификации на основе файлов cookie. Как правило, для этого Sanctum использует защиту веб-аутентификации Laravel. Это обеспечивает преимущества защиты CSRF, аутентификации сеанса, а также защищает от утечки учетных данных аутентификации через XSS.

Sanctum будет пытаться аутентифицироваться с помощью файлов cookie только в том случае, если входящий запрос исходит от вашего собственного SPA-фронтенда. Когда Sanctum проверяет входящий HTTP-запрос, он сначала проверяет наличие файла cookie аутентификации, и, если его нет, Sanctum затем проверяет заголовок авторизации на наличие действительного токена API.

prev:[[Сиды]] next:[[Authenticate Users]]
