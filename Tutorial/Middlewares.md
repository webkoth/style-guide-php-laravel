#develop/tree 

Middlewares — или, если транслитерировать этот термин на русский язык, мидлвари — это концепция фреймворка, которая широко используется в Laravel, а особенно во всех задачах, связанных с авторизацией и аутентификацией.

Мидлвари предоставляют удобный механизм для проверки и фильтрации HTTP-запросов, поступающих в ваше приложение. Например, Laravel включает мидлварь, которая проверяет подлинность пользователя вашего приложения. Если пользователь не аутентифицирован, мидлварь перенаправит клиента на экран входа в ваше приложение. Однако, если пользователь аутентифицирован, мидлварь позволит продолжить запрос дальше в приложении.

Дополнительные мидлвари могут быть написаны для выполнения различных задач помимо аутентификации. Например, мидлварь для журналирования может регистрировать все входящие запросы к вашему приложению. В структуру Laravel включено несколько middlewares, включая мидлварь для аутентификации и защиты от CSRF. Все эти мидлвари расположены в каталоге app/Http/Middleware.

## Добавление мидлвари для поддержки аутентификации

Давайте добавим мидлварь Sanctum в группу middlewares в файле app/Http/Kernel.php. Эта мидлварь отвечает за то, чтобы входящие запросы от вашего SPA могли аутентифицироваться с использованием файлов cookie сеанса Laravel, в то же время позволяя запросам от третьих лиц или мобильных приложений аутентифицироваться с использованием токенов API:

```php
'api' => [
    \Laravel\Sanctum\Http\Middleware\EnsureFrontendRequestsAreStateful::class,
    'throttle:api',
    \Illuminate\Routing\Middleware\SubstituteBindings::class,
],
```

### Защита роутов от анонимных пользователей

Чтобы защитить роуты, чтобы все входящие запросы аутентифицировались, вы должны добавить sanctum middleware к вашим маршрутам API в файле routes/api.php. Эта гарантирует, что входящие запросы аутентифицируются либо как аутентифицированные запросы с отслеживанием состояния от вашего SPA, либо содержат действительный заголовок токена API, если запрос исходит от третьей стороны:

```php
use Illuminate\Http\Request;
 
Route::middleware('auth:sanctum')->get('/user', function (Request $request) {
    return $request->user();
});
```

### Как работает проверка аутентификации средства sanctum

Давайте разберёмся более детально что происходит при каждом запросе, когда вы добавили `middleware('auth:sanctum')` к нужным роутам.

Вначале Sanctum проверит, что в запросе присутствует заголовок Authorization и получит из него значение токена доступа. Затем Sanctum попробует найти такой токен в таблице токенов, а заодно проверить его валидность (токен не должен быть просрочен). Если с токеном всё в порядке, то будет сгенерировано событие с этим токеном. Далее это событие перехватят другие компоненты Laravel и добавят юзера-владельца этого токена в свойство для хранения залогиненного пользователя.

## Группы

Иногда вам может понадобиться сгруппировать несколько middlewares под одним ключом, чтобы упростить их назначение роутам. Вы можете сделать это, используя свойство $middlewareGroups вашего ядра HTTP.

По умолчанию Laravel поставляется с группами middlewares web и api, которые содержат общее поведение, которое вы можете применить к своим веб и API роутам. Помните, что эти группы автоматически применяются сервис-провайдером App\Providers\RouteServiceProvider вашего приложения к роутам в соответствующих файлах:

```php
/**
 * The application's route middleware groups.
 *
 * @var array
 */
protected $middlewareGroups = [
    'web' => [
        \App\Http\Middleware\EncryptCookies::class,
        \Illuminate\Cookie\Middleware\AddQueuedCookiesToResponse::class,
        \Illuminate\Session\Middleware\StartSession::class,
        \Illuminate\View\Middleware\ShareErrorsFromSession::class,
        \App\Http\Middleware\VerifyCsrfToken::class,
        \Illuminate\Routing\Middleware\SubstituteBindings::class,
    ],
 
    'api' => [
        'throttle:api',
        \Illuminate\Routing\Middleware\SubstituteBindings::class,
    ],
];
```

prev:[[Authenticate Users]] next:[[2_resources/develop/laravel/tutorial/Validation]]
